<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bhuiyan Chat</title>
<style>
  body { margin:0; font-family:'Segoe UI',sans-serif; background:#0a0a0a; color:#eee; }
  button { cursor:pointer; border:none; border-radius:6px; padding:10px 20px; background:#6a0dad; color:#fff; font-weight:bold; }
  button:hover { background:#8a2be2; }
  .page { display:none; padding:20px; }
  .active { display:block; }
  #loginPage { display:flex; flex-direction:column; justify-content:center; align-items:center; height:100vh; }
  input[type=text] { padding:10px; margin:10px 0; border-radius:6px; border:none; width:200px; }
  #homePage h2 { margin-top:0; }
  .friend-list { list-style:none; padding:0; }
  .friend-item { background:#1a1a1a; padding:15px; margin-bottom:10px; border-radius:6px; }
  .friend-item:hover { background:#2a2a2a; }
  #chatPage { display:flex; flex-direction:column; height:100vh; }
  #chatHeader { background:#1a1a1a; padding:15px; display:flex; justify-content:space-between; align-items:center; font-weight:bold; }
  #messages { flex:1; overflow-y:auto; padding:15px; }
  .message { margin-bottom:10px; padding:10px; border-radius:12px; max-width:70%; }
  .sent { background:#6a0dad; align-self:flex-end; color:#fff; }
  .received { background:#2a2a2a; align-self:flex-start; color:#fff; }
  #messageInputContainer { display:flex; padding:10px; background:#1a1a1a; }
  #messageInput { flex:1; padding:10px; border-radius:6px; border:none; margin-right:10px; }
  .backBtn { background:#4b0082; }
  .backBtn:hover { background:#6a0dad; }
</style>
</head>
<body>

<!-- Login Page -->
<div id="loginPage" class="page active">
  <h1>Bhuiyan Chat</h1>
  <input type="text" id="usernameInput" placeholder="Enter your username">
  <button onclick="login()">Login</button>
</div>

<!-- Home Page -->
<div id="homePage" class="page">
  <h2>Welcome, <span id="currentUser"></span></h2>
  <button onclick="logout()">Logout</button>
  <h3>Friends</h3>
  <ul id="friendList" class="friend-list"></ul>
  <input type="text" id="friendInput" placeholder="Add friend">
  <button onclick="addFriend()">Add Friend</button>
</div>

<!-- Chat Page -->
<div id="chatPage" class="page">
  <div id="chatHeader">
    <span id="chatWith"></span>
    <button class="backBtn" onclick="backToHome()">Back</button>
  </div>
  <div id="messages"></div>
  <div id="messageInputContainer">
    <input type="text" id="messageInput" placeholder="Type a message">
    <button onclick="sendMessage()">Send</button>
  </div>
</div>

<!-- Firebase CDN -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<script>
  // --- Firebase Config ---
  const firebaseConfig = {
    apiKey: "AIzaSyBeOAa7AyXCvhG8Me3rPJLbRa26Q3yzDD0",
    authDomain: "bhuiyan-chat-53e86.firebaseapp.com",
    databaseURL: "https://bhuiyan-chat-53e86-default-rtdb.firebaseio.com",
    projectId: "bhuiyan-chat-53e86",
    storageBucket: "bhuiyan-chat-53e86.firebasestorage.app",
    messagingSenderId: "509100356906",
    appId: "1:509100356906:web:357d12fc14daae164d9a53"
  };

  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  const auth = firebase.auth();

  let currentUser = '';
  let currentUid = '';
  let activeChat = '';

  // --- Login ---
  window.login = () => {
    const username = document.getElementById('usernameInput').value.trim();
    if(!username) return alert("Enter username");

    auth.signInAnonymously()
      .then(userCredential => {
        currentUid = userCredential.user.uid;
        currentUser = username;
        document.getElementById('currentUser').innerText = currentUser;

        // Save user in database
        db.ref('users/' + currentUid).set({ username: currentUser });

        showPage('homePage');
        loadFriends();
      })
      .catch(error => alert("Error signing in: " + error.message));
  };

  window.logout = () => {
    currentUser = '';
    currentUid = '';
    activeChat = '';
    auth.signOut();
    showPage('loginPage');
  };

  // --- Friends ---
  window.addFriend = () => {
    const friendName = document.getElementById('friendInput').value.trim();
    if(!friendName) return;
    if(friendName === currentUser) return alert("Cannot add yourself");

    db.ref('users').orderByChild('username').equalTo(friendName).once('value', snapshot => {
      if(snapshot.exists()){
        const friendUid = Object.keys(snapshot.val())[0];
        db.ref(`friends/${currentUid}/${friendUid}`).set(friendName);
        db.ref(`friends/${friendUid}/${currentUid}`).set(currentUser);
        document.getElementById('friendInput').value = '';
      } else {
        alert("User not found");
      }
    });
  };

  function loadFriends() {
    const friendList = document.getElementById('friendList');
    db.ref('friends/' + currentUid).on('value', snapshot => {
      friendList.innerHTML = '';
      const data = snapshot.val() || {};
      Object.keys(data).forEach(friendUid => {
        const friendName = data[friendUid];
        const li = document.createElement('li');
        li.className = 'friend-item';
        li.innerText = friendName;
        li.onclick = () => openChat(friendUid, friendName);
        friendList.appendChild(li);
      });
    });
  }

  // --- Chat ---
  function getChatId(uid1, uid2) {
    return [uid1, uid2].sort().join('_');
  }

  function openChat(friendUid, friendName) {
    activeChat = friendUid;
    document.getElementById('chatWith').innerText = friendName;
    showPage('chatPage');
    loadMessages();
  }

  window.backToHome = () => {
    activeChat = '';
    showPage('homePage');
  };

  window.sendMessage = () => {
    const msgInput = document.getElementById('messageInput');
    const msg = msgInput.value.trim();
    if(!msg || !activeChat) return;
    const timestamp = Date.now();
    db.ref('messages/' + getChatId(currentUid, activeChat)).push({
      sender: currentUser,
      text: msg,
      timestamp
    });
    msgInput.value = '';
  };

  function loadMessages() {
    if(!activeChat) return;
    const messagesDiv = document.getElementById('messages');
    db.ref('messages/' + getChatId(currentUid, activeChat)).on('value', snapshot => {
      messagesDiv.innerHTML = '';
      const data = snapshot.val() || {};
      Object.values(data).forEach(msg => {
        const div = document.createElement('div');
        div.className = 'message ' + (msg.sender === currentUser ? 'sent' : 'received');
        div.innerText = msg.sender + ': ' + msg.text;
        messagesDiv.appendChild(div);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      });
    });
  }

  // --- Helper ---
  function showPage(pageId) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById(pageId).classList.add('active');
  }
</script>

</body>
</html>
