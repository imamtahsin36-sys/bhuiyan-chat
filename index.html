<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600;800&display=swap" rel="stylesheet">
<title>✦ Bhuiyan Chat ✦</title>

<style>
*{box-sizing:border-box;}
body{
  margin:0;
  font-family:'Segoe UI',sans-serif;
  color:#fff;
  background:
    radial-gradient(circle at 20% 20%, rgba(138,43,226,0.3), transparent 40%),
    radial-gradient(circle at 80% 80%, rgba(106,13,173,0.4), transparent 40%),
    linear-gradient(135deg, #0a0a0a 0%, #140019 100%);
}
h1{
  font-family:'Orbitron',sans-serif;
  font-size:28px;
  text-align:center;
  background: linear-gradient(90deg,#c084fc,#9333ea);
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
  margin-bottom:10px;
}
button{
  cursor:pointer;
  border-radius:12px;
  padding:8px 14px;
  border:1px solid rgba(255,255,255,0.2);
  background: rgba(138,43,226,0.2);
  color:#fff;
  font-weight:bold;
  font-size:13px;
}
.page{ display:none; padding:20px; }
.active{ display:block; }
.friend-item{
  display:flex;
  justify-content:space-between;
  align-items:center;
  background: rgba(255,255,255,0.05);
  padding:10px 14px;
  border-radius:18px;
  width:100%;
  max-width:500px;
  margin-bottom:12px;
}
.friend-left{
  display:flex;
  flex-direction:column;
  cursor:pointer;
  max-width:85%;
}
.friend-name{ font-weight:bold; font-size:14px; }
.friend-status{ font-size:11px; opacity:0.8; }
.friend-last{ font-size:12px; opacity:0.7; max-width:100%; overflow:hidden; white-space:nowrap; text-overflow:ellipsis; }
.friend-time{ font-size:10px; opacity:0.6; margin-left:6px; }
#chatPage{ display:flex; flex-direction:column; height:100vh; max-width:500px; position:relative; }
#chatHeader{
  display:flex; align-items:center; padding:10px 15px; font-weight:bold;
  position:sticky; top:0; background:rgba(0,0,0,0.5); z-index:10;
}
#chatHeader span{ flex:1; font-size:16px; }
#chatHeader button{ margin-left:auto; font-size:16px; padding:6px 10px; }
#messages{
  flex:1; overflow-y:auto; padding:10px; display:flex; flex-direction:column; gap:8px;
}
#messages::after { content: ''; display:block; height:60px; }
.message{ display:flex; align-items:flex-end; justify-content:space-between; max-width:70%; padding:8px 10px; border-radius:18px; word-break:break-word; position:relative; font-size:14px; transition: all 0.3s ease; }
.message.sent{ background:#9333ea; align-self:flex-end; }
.message.received{ background:rgba(255,255,255,0.15); align-self:flex-start; }
.message.new{ opacity:0; transform:translateY(20px); }
.message.removing{ opacity:0; transform:scale(0.8); height:0; margin:0; padding:0; overflow:hidden; transition: all 0.3s ease; }
.message span.timeStamp{ font-size:10px; margin-left:6px; color:#eee; opacity:0.7; }
.message .delBtn{ font-size:11px; margin-left:6px; padding:2px 4px; background:red; border:none; border-radius:6px; }
#messageInputContainer{
  display:flex; padding:10px; position:sticky; bottom:0; background:rgba(0,0,0,0.5); z-index:10;
}
#messageInput{ flex:1; padding:10px 12px; border-radius:12px; border:none; }
.typing-dots { display:inline-block; margin-left:5px; width:20px; text-align:left; }
.typing-dots span{ display:inline-block; width:4px; height:4px; margin-right:2px; background:#fff; border-radius:50%; animation:bounce 1s infinite; }
.typing-dots span:nth-child(2){animation-delay:0.2s;}
.typing-dots span:nth-child(3){animation-delay:0.4s;}
@keyframes bounce{ 0%,80%,100%{transform:scale(0);} 40%{transform:scale(1);} }
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginPage" class="page active">
  <h1>✦ Bhuiyan Chat ✦</h1>
  <input type="text" id="usernameInput" placeholder="Enter username">
  <button onclick="login()">Login</button>
</div>

<!-- HOME -->
<div id="homePage" class="page">
  <h2>Welcome, <span id="currentUser"></span></h2>
  <button onclick="logout()">Logout</button>
  <h3>Friends</h3>
  <ul id="friendList"></ul>
  <input type="text" id="friendInput" placeholder="Add friend">
  <button onclick="addFriend()">Add Friend</button>
</div>

<!-- CHAT -->
<div id="chatPage" class="page">
  <div id="chatHeader">
    <span id="chatWith"></span>
    <button onclick="backToHome()">←</button>
  </div>
  <div id="messages"></div>
  <div id="messageInputContainer">
    <input type="text" id="messageInput" placeholder="Type message">
    <button onclick="sendMessage()">Send</button>
  </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBeOAa7AyXCvhG8Me3rPJLbRa26Q3yzDD0",
  authDomain: "bhuiyan-chat-53e86.firebaseapp.com",
  databaseURL: "https://bhuiyan-chat-53e86-default-rtdb.firebaseio.com",
  projectId: "bhuiyan-chat-53e86",
  storageBucket: "bhuiyan-chat-53e86.appspot.com",
  messagingSenderId: "509100356906",
  appId: "1:509100356906:web:357d12fc14daae164d9a53"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const auth = firebase.auth();

let currentUid='', currentUser='', activeChatUid='', activeChatRef=null;
let activeFriendName='', typingTimeout='', isTyping=false, friendStatusText='offline';

// AUTO LOGIN
window.addEventListener('DOMContentLoaded', ()=>{
  const savedUser = localStorage.getItem('bhuiyanChatUser');
  const savedUid = localStorage.getItem('bhuiyanChatUid');
  if(savedUser && savedUid){
    currentUid = savedUid; currentUser = savedUser;
    document.getElementById('currentUser').innerText = currentUser;
    showPage('homePage');
    const statusRef = db.ref('status/'+currentUid);
    statusRef.set({state:"online"});
    statusRef.onDisconnect().set({state:"offline", lastChanged:Date.now()});
    loadFriends();
  }
});

// LOGIN
window.login = ()=>{
  const username = document.getElementById('usernameInput').value.trim();
  if(!username) return alert("Enter username");
  auth.signInAnonymously().then(cred=>{
    currentUid = cred.user.uid; currentUser = username;
    localStorage.setItem('bhuiyanChatUser', username);
    localStorage.setItem('bhuiyanChatUid', currentUid);
    db.ref('users/'+currentUid).set({username});
    const statusRef = db.ref('status/'+currentUid);
    statusRef.set({state:"online"});
    statusRef.onDisconnect().set({state:"offline", lastChanged:Date.now()});
    document.getElementById('currentUser').innerText = username;
    showPage('homePage');
    loadFriends();
  });
};

// LOGOUT
window.logout = ()=>{
  db.ref('status/'+currentUid).set({state:"offline"});
  auth.signOut();
  localStorage.removeItem('bhuiyanChatUser');
  localStorage.removeItem('bhuiyanChatUid');
  showPage('loginPage');
};

// FRIENDS
window.addFriend = ()=>{
  const friendName = document.getElementById('friendInput').value.trim();
  if(!friendName || friendName===currentUser) return alert("Invalid friend name");
  db.ref('users').orderByChild('username').equalTo(friendName).once('value', snap=>{
    if(snap.exists()){
      const friendUid = Object.keys(snap.val())[0];
      db.ref(`friends/${currentUid}/${friendUid}`).set(friendName);
      db.ref(`friends/${friendUid}/${currentUid}`).set(currentUser);
      document.getElementById('friendInput').value='';
    }else alert("User not found");
  });
};

function loadFriends(){
  const friendList=document.getElementById('friendList');
  db.ref('friends/'+currentUid).on('value',snap=>{
    friendList.innerHTML='';
    const data = snap.val()||{};
    Object.keys(data).forEach(friendUid=>{
      const friendName = data[friendUid];
      const li = document.createElement('li'); li.className='friend-item';
      const left = document.createElement('div'); left.className='friend-left';
      left.onclick = ()=> openChat(friendUid, friendName);
      const name = document.createElement('span'); name.className='friend-name'; name.innerText=friendName;
      const status = document.createElement('span'); status.className='friend-status';
      status.innerText='offline'; status.style.color='#aaa';
      db.ref('status/' + friendUid).on('value', s=>{
        if(s.exists()){
          const state = s.val().state;
          status.innerText = state;
          status.style.color = (state==='online') ? 'lime' : '#aaa';
        }
      });
      const last = document.createElement('span'); last.className='friend-last';
      const time = document.createElement('span'); time.className='friend-time';
      db.ref('messages/'+getChatId(currentUid,friendUid)).limitToLast(1).on('value',m=>{
        const msg = m.val();
        if(msg){
          const key=Object.keys(msg)[0]; const val=msg[key];
          last.innerText=(val.senderUid===currentUid?"You: ":"")+val.text;
          const d=new Date(val.timestamp);
          time.innerText=d.getHours().toString().padStart(2,'0')+":"+d.getMinutes().toString().padStart(2,'0');
        }else{ last.innerText=""; time.innerText=""; }
      });
      left.appendChild(name); left.appendChild(status); left.appendChild(last); li.appendChild(left);
      const delBtn = document.createElement('button'); delBtn.className='delBtn'; delBtn.innerText='❌';
      delBtn.onclick=()=>{ if(confirm(`Remove ${friendName}?`)){ db.ref(`friends/${currentUid}/${friendUid}`).remove(); db.ref(`friends/${friendUid}/${currentUid}`).remove(); }};
      li.appendChild(delBtn); friendList.appendChild(li);
    });
  });
}

// CHAT
function getChatId(a,b){ return [a,b].sort().join('_'); }

function openChat(uid,name){
  activeChatUid = uid; activeFriendName=name; isTyping=false; friendStatusText='offline';
  const header = document.getElementById('chatWith');
  header.innerText = activeFriendName;
  // listen to online status
  db.ref('status/'+activeChatUid).on('value', snap=>{
    if(snap.exists()){
      friendStatusText = snap.val().state;
      if(isTyping){
        header.innerHTML = `${activeFriendName} (${friendStatusText}) <span class="typing-dots"><span></span><span></span><span></span></span>`;
      } else { header.innerText = `${activeFriendName} (${friendStatusText})`; }
    }
  });
  showPage('chatPage'); loadMessages(); setupTypingIndicator(); markMessagesSeen();
}

function markMessagesSeen(){
  const chatRef = db.ref('messages/'+getChatId(currentUid, activeChatUid));
  chatRef.once('value',snap=>{
    const data = snap.val()||{};
    Object.entries(data).forEach(([msgId,msg])=>{
      if(msg.senderUid!==currentUid && !msg.seen){ chatRef.child(msgId).update({seen:true}); }
    });
  });
}

window.sendMessage=()=>{
  const input=document.getElementById('messageInput'); const text=input.value.trim();
  if(!text || !activeChatUid) return;
  db.ref('messages/'+getChatId(currentUid,activeChatUid)).push({senderUid:currentUid,text,timestamp:Date.now(),seen:false});
  input.value=''; db.ref('typing/'+getChatId(currentUid,activeChatUid)+'/'+currentUid).set(false);
};

function setupTypingIndicator(){
  const input=document.getElementById('messageInput'); const header=document.getElementById('chatWith');
  input.addEventListener('input',()=>{
    if(!activeChatUid) return;
    db.ref('typing/'+getChatId(currentUid,activeChatUid)+'/'+currentUid).set(true);
    if(typingTimeout) clearTimeout(typingTimeout);
    typingTimeout = setTimeout(()=> db.ref('typing/'+getChatId(currentUid,activeChatUid)+'/'+currentUid).set(false),1000);
  });
  db.ref('typing/'+getChatId(currentUid,activeChatUid)+'/'+activeChatUid).on('value',snap=>{
    isTyping = snap.exists() && snap.val();
    header.innerHTML = isTyping ? `${activeFriendName} (${friendStatusText}) <span class="typing-dots"><span></span><span></span><span></span></span>` : `${activeFriendName} (${friendStatusText})`;
  });
}

function loadMessages(){
  const messagesDiv = document.getElementById('messages');
  const chatRef = db.ref('messages/'+getChatId(currentUid,activeChatUid));
  if(activeChatRef) activeChatRef.off(); activeChatRef = chatRef;
  let renderedMessages={};

  chatRef.on('child_added', snap=>{
    const msgId=snap.key; const msg=snap.val();
    if(renderedMessages[msgId]) return; renderedMessages[msgId]=true;

    const div=document.createElement('div');
    div.className='message '+(msg.senderUid===currentUid?'sent':'received')+' new';
    const textSpan=document.createElement('span'); textSpan.innerText=msg.text; div.appendChild(textSpan);

    const rightDiv=document.createElement('div'); rightDiv.style.display='flex'; rightDiv.style.alignItems='center';
    const time=document.createElement('span'); time.className='timeStamp';
    const d=new Date(msg.timestamp); time.innerText=d.getHours().toString().padStart(2,'0')+":"+d.getMinutes().toString().padStart(2,'0');
    rightDiv.appendChild(time);

    if(msg.senderUid===currentUid){
      const delBtn=document.createElement('button'); delBtn.className='delBtn'; delBtn.innerText='🗑️';
      delBtn.onclick=()=>{ if(confirm('Delete this message?')){ div.classList.add('removing'); setTimeout(()=> chatRef.child(msgId).remove(),300); } };
      rightDiv.appendChild(delBtn);

      const seenSpan=document.createElement('span'); seenSpan.style.fontSize='10px'; seenSpan.style.marginLeft='4px'; seenSpan.style.opacity='0.7';
      seenSpan.innerText=msg.seen?'✔✔':'✔'; rightDiv.appendChild(seenSpan);
      div.seenSpan=seenSpan;
    }

    div.appendChild(rightDiv); messagesDiv.appendChild(div);
    requestAnimationFrame(()=> div.classList.remove('new'));
    messagesDiv.scrollTo({top:messagesDiv.scrollHeight,behavior:'smooth'});
  });

  chatRef.on('child_changed',snap=>{
    const msg = snap.val();
    const msgDivs = Array.from(messagesDiv.children);
    msgDivs.forEach(div=>{ if(div.seenSpan && div.querySelector('span').innerText===msg.text){ div.seenSpan.innerText=msg.seen?'✔✔':'✔'; } });
  });

  chatRef.on('child_removed',snap=>{
    const msgDivs = Array.from(messagesDiv.children);
    msgDivs.forEach(div=>{ if(div.querySelector('span').innerText===snap.val()?.text){ div.classList.add('removing'); setTimeout(()=>div.remove(),300); } });
  });
}

function backToHome(){ if(activeChatRef) activeChatRef.off(); activeChatUid=null; showPage('homePage'); }
function showPage(id){ document.querySelectorAll('.page').forEach(p=>p.classList.remove('active')); document.getElementById(id).classList.add('active'); }
window.addEventListener('beforeunload',()=>{ if(currentUid) db.ref('status/'+currentUid).set({state:"offline",lastChanged:Date.now()}); });
</script>
</body>
</html>
