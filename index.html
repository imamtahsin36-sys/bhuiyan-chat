<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600;800&display=swap" rel="stylesheet">
<title>✦ Bhuiyan Chat ✦</title>

<style>
*{box-sizing:border-box;}
body{
  margin:0;
  font-family:'Segoe UI',sans-serif;
  color:#fff;
  background:
    radial-gradient(circle at 20% 20%, rgba(138,43,226,0.3), transparent 40%),
    radial-gradient(circle at 80% 80%, rgba(106,13,173,0.4), transparent 40%),
    linear-gradient(135deg, #0a0a0a 0%, #140019 100%);
}

/* TITLE */
h1{
  font-family:'Orbitron',sans-serif;
  font-size:28px;
  text-align:center;
  background: linear-gradient(90deg,#c084fc,#9333ea);
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
  margin-bottom:10px;
}

/* BUTTON */
button{
  cursor:pointer;
  border-radius:12px;
  padding:8px 14px;
  border:1px solid rgba(255,255,255,0.2);
  background: rgba(138,43,226,0.2);
  color:#fff;
  font-weight:bold;
  font-size:13px;
}

/* PAGE */
.page{ display:none; padding:20px; }
.active{ display:block; }

/* FRIEND CARD */
.friend-item{
  display:flex;
  justify-content:space-between;
  align-items:center;
  background: rgba(255,255,255,0.05);
  padding:10px 14px;
  border-radius:18px;
  width:100%;
  max-width:500px;
  margin-bottom:12px;
}

.friend-left{
  display:flex;
  flex-direction:column;
  cursor:pointer;
  max-width:85%;
}

.friend-name{
  font-weight:bold;
  font-size:14px;
}

.friend-status{
  font-size:11px;
  opacity:0.8;
}

.friend-last{
  font-size:12px;
  opacity:0.7;
  max-width:100%;
  overflow:hidden;
  white-space:nowrap;
  text-overflow:ellipsis;
}

.friend-time{
  font-size:10px;
  opacity:0.6;
  margin-left:6px;
}

/* CHAT */
#chatPage{
  display:flex;
  flex-direction:column;
  height:100vh;
  max-width:500px;
}

#chatHeader{
  display:flex;
  align-items:center;
  padding:10px 15px;
  font-weight:bold;
}

#chatHeader span{
  flex:1;
  font-size:16px;
}

#chatHeader button{
  margin-left:auto;
  font-size:16px;
  padding:6px 10px;
}

/* MESSAGES */
#messages{
  flex:1;
  overflow-y:auto;
  padding:10px;
  display:flex;
  flex-direction:column;
  gap:8px;
}

.message{
  display:flex;
  align-items:flex-end;
  justify-content:space-between;
  max-width:70%;
  padding:8px 10px;
  border-radius:18px;
  word-break:break-word;
  position:relative;
  font-size:14px;
}

.sent{ background:#9333ea; align-self:flex-end; }
.received{ background:rgba(255,255,255,0.15); align-self:flex-start; }

.message span.timeStamp{
  font-size:10px;
  margin-left:6px;
  color:#eee;
  opacity:0.7;
}

.message .delBtn{
  font-size:11px;
  margin-left:6px;
  padding:2px 4px;
  background:red;
  border:none;
  border-radius:6px;
}

/* INPUT */
#messageInputContainer{
  display:flex;
  padding:10px;
}
#messageInput{
  flex:1;
  padding:10px 12px;
  border-radius:12px;
  border:none;
}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginPage" class="page active">
  <h1>✦ Bhuiyan Chat ✦</h1>
  <input type="text" id="usernameInput" placeholder="Enter username">
  <button onclick="login()">Login</button>
</div>

<!-- HOME -->
<div id="homePage" class="page">
  <h2>Welcome, <span id="currentUser"></span></h2>
  <button onclick="logout()">Logout</button>
  <h3>Friends</h3>
  <ul id="friendList"></ul>
  <input type="text" id="friendInput" placeholder="Add friend">
  <button onclick="addFriend()">Add Friend</button>
</div>

<!-- CHAT -->
<div id="chatPage" class="page">
  <div id="chatHeader">
    <span id="chatWith"></span>
    <button onclick="backToHome()">←</button>
  </div>
  <div id="messages"></div>
  <div id="messageInputContainer">
    <input type="text" id="messageInput" placeholder="Type message">
    <button onclick="sendMessage()">Send</button>
  </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBeOAa7AyXCvhG8Me3rPJLbRa26Q3yzDD0",
  authDomain: "bhuiyan-chat-53e86.firebaseapp.com",
  databaseURL: "https://bhuiyan-chat-53e86-default-rtdb.firebaseio.com",
  projectId: "bhuiyan-chat-53e86",
  storageBucket: "bhuiyan-chat-53e86.appspot.com",
  messagingSenderId: "509100356906",
  appId: "1:509100356906:web:357d12fc14daae164d9a53"
};
firebase.initializeApp(firebaseConfig);

const db = firebase.database();
const auth = firebase.auth();

let currentUid='', currentUser='', activeChatUid='', activeChatRef=null;
let activeFriendName='';
let typingTimeout;

/* LOGIN */
window.login=()=>{
  const username=document.getElementById('usernameInput').value.trim();
  if(!username) return alert("Enter username");

  auth.signInAnonymously().then(cred=>{
    currentUid=cred.user.uid;
    currentUser=username;
    db.ref('users/'+currentUid).set({username});

    const statusRef = db.ref('status/'+currentUid);
    statusRef.set({state:"online"});
    statusRef.onDisconnect().set({state:"offline", lastChanged:Date.now()});

    document.getElementById('currentUser').innerText=username;
    showPage('homePage');
    loadFriends();
  });
};

/* LOGOUT */
window.logout=()=>{
  db.ref('status/'+currentUid).set({state:"offline"});
  auth.signOut();
  showPage('loginPage');
};

/* UPDATE STATUS ON CLOSE */
window.addEventListener('beforeunload', ()=>{
  if(currentUid) db.ref('status/'+currentUid).set({state:"offline", lastChanged:Date.now()});
});

/* ADD FRIEND */
window.addFriend=()=>{
  const friendName=document.getElementById('friendInput').value.trim();
  if(!friendName || friendName===currentUser) return alert("Invalid friend name");

  db.ref('users').orderByChild('username').equalTo(friendName).once('value',snap=>{
    if(snap.exists()){
      const friendUid=Object.keys(snap.val())[0];
      db.ref(`friends/${currentUid}/${friendUid}`).set(friendName);
      db.ref(`friends/${friendUid}/${currentUid}`).set(currentUser);
      document.getElementById('friendInput').value='';
    } else alert("User not found");
  });
};

/* LOAD FRIENDS */
function loadFriends(){
  const friendList=document.getElementById('friendList');
  db.ref('friends/'+currentUid).on('value',snap=>{
    friendList.innerHTML='';
    const data=snap.val()||{};
    Object.keys(data).forEach(friendUid=>{
      const friendName=data[friendUid];
      const li=document.createElement('li');
      li.className='friend-item';

      const left=document.createElement('div');
      left.className='friend-left';
      left.onclick=()=>openChat(friendUid,friendName);

      const name=document.createElement('span');
      name.className='friend-name';
      name.innerText=friendName;

      const status=document.createElement('span');
      status.className='friend-status';
      db.ref('status/'+friendUid).on('value',s=>{
        if(s.exists()){
          status.innerText = s.val().state;
          status.style.color = (s.val().state==='online')?'lime':'#aaa';
        }
      });

      const last=document.createElement('span');
      last.className='friend-last';

      const time=document.createElement('span');
      time.className='friend-time';

      db.ref('messages/'+getChatId(currentUid,friendUid)).limitToLast(1)
      .on('value',m=>{
        const msg=m.val();
        if(msg){
          const key=Object.keys(msg)[0];
          const val=msg[key];
          last.innerText=(val.senderUid===currentUid?"You: ":"")+val.text;
          const d=new Date(val.timestamp);
          time.innerText=d.getHours().toString().padStart(2,'0')+':'+d.getMinutes().toString().padStart(2,'0');
        } else { last.innerText=""; time.innerText=""; }
      });

      left.appendChild(name);
      left.appendChild(status);
      left.appendChild(last);
      li.appendChild(left);

      const delFriendBtn = document.createElement('button');
      delFriendBtn.className='delBtn';
      delFriendBtn.innerText='❌';
      delFriendBtn.onclick=()=>{
        if(confirm(`Remove ${friendName}?`)){
          db.ref(`friends/${currentUid}/${friendUid}`).remove();
          db.ref(`friends/${friendUid}/${currentUid}`).remove();
        }
      };
      li.appendChild(delFriendBtn);

      friendList.appendChild(li);
    });
  });
}

/* CHAT */
function getChatId(a,b){ return [a,b].sort().join('_'); }

function openChat(uid,name){
  activeChatUid=uid;
  activeFriendName=name;
  document.getElementById('chatWith').innerText=name;
  showPage('chatPage');
  loadMessages();
  setupTypingIndicator();
}

window.sendMessage=()=>{
  const input=document.getElementById('messageInput');
  const text=input.value.trim();
  if(!text || !activeChatUid) return;
  db.ref('messages/'+getChatId(currentUid,activeChatUid)).push({
    senderUid:currentUid,
    text,
    timestamp:Date.now()
  });
  input.value='';
  db.ref('typing/'+getChatId(currentUid,activeChatUid)+'/'+currentUid).set(false);
};

/* Typing */
function setupTypingIndicator(){
  const input=document.getElementById('messageInput');
  input.addEventListener('input', ()=>{
    if(!activeChatUid) return;
    db.ref('typing/'+getChatId(currentUid,activeChatUid)+'/'+currentUid).set(true);

    if(typingTimeout) clearTimeout(typingTimeout);
    typingTimeout = setTimeout(()=>{
      db.ref('typing/'+getChatId(currentUid,activeChatUid)+'/'+currentUid).set(false);
    }, 1000);
  });

  db.ref('typing/'+getChatId(currentUid,activeChatUid)+'/'+activeChatUid)
    .on('value',snap=>{
      const chatHeader = document.getElementById('chatWith');
      if(snap.exists() && snap.val()){
        chatHeader.innerText = activeFriendName + " (typing...)";
      } else {
        chatHeader.innerText = activeFriendName;
      }
    });
}

/* Load Messages */
function loadMessages(){
  const messagesDiv=document.getElementById('messages');
  const chatRef=db.ref('messages/'+getChatId(currentUid,activeChatUid));
  if(activeChatRef) activeChatRef.off();
  activeChatRef=chatRef;

  chatRef.on('value',snap=>{
    messagesDiv.innerHTML='';
    const data=snap.val()||{};
    Object.entries(data).sort((a,b)=>a[1].timestamp-b[1].timestamp)
    .forEach(([msgId,msg])=>{
      const div=document.createElement('div');
      div.className='message '+(msg.senderUid===currentUid?'sent':'received');

      const textSpan = document.createElement('span');
      textSpan.innerText = msg.text;
      div.appendChild(textSpan);

      const rightDiv = document.createElement('div');
      rightDiv.style.display='flex';
      rightDiv.style.alignItems='center';

      const time=document.createElement('span');
      time.className='timeStamp';
      const d=new Date(msg.timestamp);
      time.innerText=d.getHours().toString().padStart(2,'0')+":"+d.getMinutes().toString().padStart(2,'0');
      rightDiv.appendChild(time);

      if(msg.senderUid===currentUid){
        const delMsgBtn = document.createElement('button');
        delMsgBtn.className='delBtn';
        delMsgBtn.innerText='🗑️';
        delMsgBtn.onclick = ()=>{
          if(confirm('Delete this message?')){
            db.ref('messages/'+getChatId(currentUid,activeChatUid)+'/'+msgId).remove();
          }
        };
        rightDiv.appendChild(delMsgBtn);
      }

      div.appendChild(rightDiv);
      messagesDiv.appendChild(div);
    });
    messagesDiv.scrollTop=messagesDiv.scrollHeight;
  });
}

function backToHome(){
  if(activeChatRef) activeChatRef.off();
  activeChatUid=null;
  showPage('homePage');
}

function showPage(id){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}
</script>
</body>
</html>
