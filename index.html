<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Fancy Font -->
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600;800&display=swap" rel="stylesheet">

<title>✦ Bhuiyan Chat ✦</title>

<style>
/* ===================== GLOBAL ===================== */
*{box-sizing:border-box;}
body{
  margin:0;
  font-family:'Segoe UI',sans-serif;
  color:#fff;
  background:
    radial-gradient(circle at 20% 20%, rgba(138,43,226,0.3), transparent 40%),
    radial-gradient(circle at 80% 80%, rgba(106,13,173,0.4), transparent 40%),
    linear-gradient(135deg, #0a0a0a 0%, #140019 100%);
  backdrop-filter: blur(20px);
}

/* ===================== TITLE ===================== */
h1{
  font-family:'Orbitron', sans-serif;
  font-size:32px;
  text-align:center;
  margin-bottom:20px;
  letter-spacing:2px;
  background: linear-gradient(90deg,#c084fc,#9333ea);
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
  text-shadow:0 0 20px rgba(147,51,234,0.6);
}

/* ===================== BUTTONS ===================== */
button{
  cursor:pointer;
  border-radius:12px;
  padding:10px 18px;
  border:1px solid rgba(255,255,255,0.2);
  background: rgba(138,43,226,0.2);
  backdrop-filter: blur(10px);
  color:#fff;
  font-weight:bold;
  transition:0.3s;
}
button:hover{
  background: rgba(138,43,226,0.4);
  box-shadow:0 0 15px rgba(147,51,234,0.7);
}

/* ===================== INPUT ===================== */
input[type=text]{
  padding:10px;
  font-size:16px;
  width:100%;
  max-width:250px;
  border-radius:12px;
  margin-bottom:10px;
  border:1px solid rgba(255,255,255,0.2);
  background: rgba(255,255,255,0.05);
  color:#fff;
  backdrop-filter: blur(6px);
}

/* ===================== PAGES ===================== */
.page{ display:none; padding:20px; transition: all 0.5s ease; }
.active{ display:block; opacity:1; animation: fadeIn 0.5s;}
@keyframes fadeIn {0%{opacity:0;}100%{opacity:1;}}

/* ===================== FRIENDS ===================== */
.friend-item{
  background: rgba(255,255,255,0.05);
  padding:8px;
  margin-bottom:10px;
  border-radius:12px;
  display:flex; align-items:center;
  justify-content:space-between;
  backdrop-filter: blur(8px);
}

/* ===================== CHAT ===================== */
#chatPage{
  display:flex; 
  flex-direction:column; 
  height:100vh; 
  width:100%; 
  max-width:500px;
}
#chatHeader{
  padding:10px 15px;
  display:flex; 
  align-items:center;
  font-weight:bold;
  width:100%;
}
#messages{
  flex:1;
  overflow-y:auto;
  padding:15px;
  display:flex; 
  flex-direction:column;
  gap:10px;
  background: rgba(0,0,0,0.1);
  border-radius:12px;
  margin-bottom:10px;
}
.message{
  max-width:70%;
  padding:10px 12px;
  border-radius:18px;
  word-break: break-word;
  position:relative;
}
.sent{
  align-self:flex-end;
  background: #9333ea;
  border-bottom-right-radius:0;
  color:#fff;
}
.received{
  align-self:flex-start;
  background: rgba(255,255,255,0.15);
  color:#fff;
}

/* ===================== MESSAGE INPUT ===================== */
#messageInputContainer{
  display:flex;
  padding:10px;
  width:100%;
  max-width:500px;
}
#messageInput{
  flex:1;
  padding:12px;
  font-size:16px;
  border-radius:12px;
  border:1px solid rgba(255,255,255,0.2);
  background: rgba(255,255,255,0.05);
  color:#fff;
  backdrop-filter: blur(6px);
  margin-right:10px;
}
#messageInput + button{
  padding:12px 18px;
  font-size:16px;
}

/* ===================== DELETE BUTTON ===================== */
.delBtn{
  padding:2px 5px;
  font-size:12px;
  margin-left:8px;
  border-radius:6px;
  background:#ff0000;
  border:none;
  cursor:pointer;
}

/* ===================== RESPONSIVE ===================== */
@media(max-width:600px){
  h1{ font-size:26px; }
  #loginPage input, #loginPage button, #friendInput, #friendList li, #messageInputContainer input, #messageInputContainer button{
    max-width:90%;
  }
}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginPage" class="page active">
  <h1>✦ Bhuiyan Chat ✦</h1>
  <input type="text" id="usernameInput" placeholder="Enter username">
  <button onclick="login()">Login</button>
</div>

<!-- HOME -->
<div id="homePage" class="page">
  <h2>Welcome, <span id="currentUser"></span></h2>
  <button onclick="logout()">Logout</button>

  <h3>Friends</h3>
  <ul id="friendList"></ul>
  <input type="text" id="friendInput" placeholder="Add friend">
  <button onclick="addFriend()">Add Friend</button>
</div>

<!-- CHAT -->
<div id="chatPage" class="page">
  <div id="chatHeader">
    <span id="chatWith"></span>
    <button onclick="backToHome()" class="backBtn" style="margin-left:auto;">←</button>
  </div>
  <div id="messages"></div>
  <div id="messageInputContainer">
    <input type="text" id="messageInput" placeholder="Type message">
    <button onclick="sendMessage()">Send</button>
  </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBeOAa7AyXCvhG8Me3rPJLbRa26Q3yzDD0",
  authDomain: "bhuiyan-chat-53e86.firebaseapp.com",
  databaseURL: "https://bhuiyan-chat-53e86-default-rtdb.firebaseio.com",
  projectId: "bhuiyan-chat-53e86",
  storageBucket: "bhuiyan-chat-53e86.appspot.com",
  messagingSenderId: "509100356906",
  appId: "1:509100356906:web:357d12fc14daae164d9a53"
};
firebase.initializeApp(firebaseConfig);

const db = firebase.database();
const auth = firebase.auth();

let currentUid='', currentUser='', activeChatUid='', activeChatRef=null;

/* LOGIN */
window.login = () => {
  const username = document.getElementById('usernameInput').value.trim();
  if(!username) return alert("Enter username");

  auth.signInAnonymously().then(cred=>{
    currentUid = cred.user.uid;
    currentUser = username;
    db.ref('users/'+currentUid).set({username});
    document.getElementById('currentUser').innerText = username;
    showPage('homePage');
    loadFriends();
  });
};

/* LOGOUT */
window.logout = () => {
  currentUid=''; currentUser=''; activeChatUid=null;
  auth.signOut();
  showPage('loginPage');
};

/* FRIENDS */
window.addFriend = () => {
  const friendName = document.getElementById('friendInput').value.trim();
  if(!friendName || friendName === currentUser) return alert("Invalid friend name");
  db.ref('users').orderByChild('username').equalTo(friendName).once('value',snap=>{
    if(snap.exists()){
      const friendUid = Object.keys(snap.val())[0];
      db.ref(`friends/${currentUid}/${friendUid}`).set(friendName);
      db.ref(`friends/${friendUid}/${currentUid}`).set(currentUser);
      document.getElementById('friendInput').value='';
    }else alert("User not found");
  });
};

function loadFriends(){
  const friendList = document.getElementById('friendList');
  db.ref('friends/'+currentUid).on('value',snap=>{
    friendList.innerHTML='';
    const data = snap.val()||{};
    Object.keys(data).forEach(friendUid=>{
      const friendName = data[friendUid];
      const li = document.createElement('li'); li.className='friend-item';
      const nameSpan = document.createElement('span'); nameSpan.innerText=friendName;
      nameSpan.style.cursor='pointer';
      nameSpan.onclick = ()=>openChat(friendUid,friendName);

      const delBtn = document.createElement('button'); delBtn.className='delBtn';
      delBtn.innerText='❌';
      delBtn.onclick = ()=>{
        if(confirm(`Remove ${friendName}?`)){
          db.ref(`friends/${currentUid}/${friendUid}`).remove();
          db.ref(`friends/${friendUid}/${currentUid}`).remove();
        }
      };

      li.appendChild(nameSpan);
      li.appendChild(delBtn);
      friendList.appendChild(li);
    });
  });
}

/* CHAT */
function getChatId(uid1,uid2){ return [uid1,uid2].sort().join('_'); }

function openChat(friendUid,friendName){
  activeChatUid=friendUid;
  document.getElementById('chatWith').innerText = friendName;
  showPage('chatPage'); 
  loadMessages();
}

window.backToHome = ()=>{
  activeChatUid=null;
  if(activeChatRef) activeChatRef.off();
  showPage('homePage');
}

window.sendMessage = ()=>{
  const input = document.getElementById('messageInput');
  const text = input.value.trim(); if(!text || !activeChatUid) return;

  db.ref('messages/'+getChatId(currentUid,activeChatUid)).push({
    senderUid:currentUid,
    senderName:currentUser,
    text,
    timestamp:Date.now()
  });

  input.value='';
};

function loadMessages(){
  if(!activeChatUid) return;
  const messagesDiv=document.getElementById('messages');
  const chatRef=db.ref('messages/'+getChatId(currentUid,activeChatUid));

  if(activeChatRef) activeChatRef.off();
  activeChatRef = chatRef;

  chatRef.on('value', snap=>{
    messagesDiv.innerHTML='';
    const data = snap.val()||{};
    Object.entries(data).sort((a,b)=>a[1].timestamp-b[1].timestamp).forEach(([msgId,msg])=>{
      const div = document.createElement('div'); 
      div.className='message '+(msg.senderUid===currentUid?'sent':'received');
      div.innerText = msg.text;

      if(msg.senderUid===currentUid){
        const delBtn = document.createElement('button'); delBtn.className='delBtn';
        delBtn.innerText='🗑️';
        delBtn.onclick = ()=>{ if(confirm('Delete this message?')) db.ref('messages/'+getChatId(currentUid,activeChatUid)+'/'+msgId).remove(); };
        div.appendChild(delBtn);
      }

      messagesDiv.appendChild(div);
    });

    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  });
}

/* PAGE SWITCH */
function showPage(id){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}
</script>
</body>
</html>
